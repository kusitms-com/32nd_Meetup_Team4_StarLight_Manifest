apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: starlight-alerts
  namespace: monitoring
  labels:
    release: prometheus
    prometheus: kube-prometheus
    app: kube-prometheus-stack
spec:
  groups:
    # ==============================================
    # Phase 1: ë¹„ì¦ˆë‹ˆìŠ¤ í¬ë¦¬í‹°ì»¬ ì•ŒëŒ (ìµœìš°ì„ )
    # ==============================================
    - name: starlight_service_critical
      interval: 30s
      rules:
        # 1. Starlight Production ì„œë¹„ìŠ¤ ì „ì²´ ë‹¤ìš´
        - alert: StarlightProductionDown
          expr: |
            kube_deployment_status_replicas_available{namespace="starlight-production", deployment=~"starlight-production.*"} == 0
          for: 1m
          labels:
            severity: critical
            service: starlight
            env: production
          annotations:
            summary: "ğŸš¨ Starlight Production ì„œë¹„ìŠ¤ ì „ì²´ ë‹¤ìš´"
            description: "ëª¨ë“  Starlight Production íŒŒë“œê°€ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ í•„ìš”!"

        # 2. Starlight Staging ì„œë¹„ìŠ¤ ë‹¤ìš´ (ëœ ê¸‰í•¨)
        - alert: StarlightStagingDown
          expr: |
            kube_deployment_status_replicas_available{namespace="starlight-staging", deployment=~"starlight-staging.*"} == 0
          for: 3m
          labels:
            severity: warning
            service: starlight
            env: staging
          annotations:
            summary: "âš ï¸ Starlight Staging ì„œë¹„ìŠ¤ ë‹¤ìš´"
            description: "Staging í™˜ê²½ì´ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."

        # 3. MySQL ë‹¤ìš´ (ë°ì´í„° ë ˆì´ì–´)
        - alert: MySQLDown
          expr: |
            kube_pod_status_phase{namespace=~"starlight-.*|ncareer", pod=~"mysql-.*", phase!="Running"} > 0
          for: 2m
          labels:
            severity: critical
            component: database
          annotations:
            summary: "ğŸ’¥ MySQL ë‹¤ìš´: {{ $labels.namespace }}"
            description: "{{ $labels.namespace }}ì˜ MySQL íŒŒë“œê°€ Running ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."

        # 4. Redis ë‹¤ìš´ (ìºì‹œ/ì„¸ì…˜ ë ˆì´ì–´)
        - alert: RedisDown
          expr: |
            kube_pod_status_phase{namespace=~"starlight-.*|ncareer", pod=~"redis-.*", phase!="Running"} > 0
          for: 2m
          labels:
            severity: critical
            component: cache
          annotations:
            summary: "ğŸ’¥ Redis ë‹¤ìš´: {{ $labels.namespace }}"
            description: "{{ $labels.namespace }}ì˜ Redis íŒŒë“œê°€ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¸ì…˜ ì†ì‹¤ ê°€ëŠ¥."

    # ==============================================
    # Phase 2: íŒŒë“œ ì•ˆì •ì„± ì•ŒëŒ
    # ==============================================
    - name: starlight_pod_stability
      interval: 1m
      rules:
        # 5. íŒŒë“œ ë°˜ë³µ ì¬ì‹œì‘ (CrashLoop ì§•í›„)
        - alert: PodRestarting
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace=~"starlight-.*|ncareer|argocd"}[15m]) * 900 > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ íŒŒë“œ ì¬ì‹œì‘ ê°ì§€: {{ $labels.namespace }}/{{ $labels.pod }}"
            description: "15ë¶„ê°„ {{ $value | humanizePercentage }}íšŒ ì¬ì‹œì‘. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜/OOM ê°€ëŠ¥ì„± í™•ì¸ í•„ìš”."

        # 6. íŒŒë“œ Critical ì¬ì‹œì‘ (ì‹¬ê°)
        - alert: PodCrashLoopingCritical
          expr: |
            rate(kube_pod_container_status_restarts_total{namespace=~"starlight-.*|ncareer"}[10m]) * 600 > 5
          for: 3m
          labels:
            severity: critical
          annotations:
            summary: "ğŸš¨ íŒŒë“œ ì§€ì†ì  CrashLoop: {{ $labels.namespace }}/{{ $labels.pod }}"
            description: "10ë¶„ê°„ 5íšŒ ì´ìƒ ì¬ì‹œì‘. ì¦‰ì‹œ ë¡œê·¸ í™•ì¸ í•„ìš”!"

        # 7. íŒŒë“œ Pending ìƒíƒœ ì§€ì† (ë¦¬ì†ŒìŠ¤ ë¶€ì¡±)
        - alert: PodStuckPending
          expr: |
            kube_pod_status_phase{namespace=~"starlight-.*|ncareer", phase="Pending"} > 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ íŒŒë“œ Pending ìƒíƒœ: {{ $labels.namespace }}/{{ $labels.pod }}"
            description: "10ë¶„ ì´ìƒ Pending. ë…¸ë“œ ë¦¬ì†ŒìŠ¤ ë¶€ì¡± ë˜ëŠ” PVC ë§ˆìš´íŠ¸ ì‹¤íŒ¨ ê°€ëŠ¥ì„±."

        # 8. OOMKilled ì¦‰ì‹œ ì•ŒëŒ
        - alert: PodOOMKilled
          expr: |
            kube_pod_container_status_terminated_reason{reason="OOMKilled", namespace=~"starlight-.*|ncareer"} > 0
          labels:
            severity: critical
          annotations:
            summary: "ğŸ’¥ íŒŒë“œ OOM Kill: {{ $labels.namespace }}/{{ $labels.pod }}"
            description: "ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ì»¨í…Œì´ë„ˆê°€ ê°•ì œ ì¢…ë£Œ. Memory Limit ì¡°ì • í•„ìš”."

    # ==============================================
    # Phase 3: ë…¸ë“œ ë¦¬ì†ŒìŠ¤ ì•ŒëŒ
    # ==============================================
    - name: node_resource_alerts
      interval: 1m
      rules:
        # 9. ë…¸ë“œ CPU ë†’ìŒ (85% ì´ìƒ 10ë¶„)
        - alert: NodeHighCPU
          expr: |
            100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ ë…¸ë“œ CPU ë†’ìŒ: {{ $labels.instance }}"
            description: "CPU ì‚¬ìš©ë¥  {{ $value | humanize }}%. ìŠ¤ì¼€ì¼ ì•„ì›ƒ ê³ ë ¤ í•„ìš”."

        # 10. ë…¸ë“œ CPU Critical (95% ì´ìƒ)
        - alert: NodeCriticalCPU
          expr: |
            100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ğŸš¨ ë…¸ë“œ CPU í¬í™”: {{ $labels.instance }}"
            description: "CPU ì‚¬ìš©ë¥  {{ $value | humanize }}%. ì¦‰ì‹œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ í•„ìš”!"

        # 11. ë…¸ë“œ ë©”ëª¨ë¦¬ ë†’ìŒ (85% ì´ìƒ)
        - alert: NodeHighMemory
          expr: |
            (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ ë…¸ë“œ ë©”ëª¨ë¦¬ ë†’ìŒ: {{ $labels.instance }}"
            description: "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  {{ $value | humanize }}%. OOM ìœ„í—˜."

        # 12. ë…¸ë“œ ë©”ëª¨ë¦¬ Critical (95% ì´ìƒ)
        - alert: NodeCriticalMemory
          expr: |
            (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ğŸš¨ ë…¸ë“œ ë©”ëª¨ë¦¬ ë¶€ì¡±: {{ $labels.instance }}"
            description: "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  {{ $value | humanize }}%. íŒŒë“œ OOM ì„ë°•!"

        # 13. ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡± (80% ì´ìƒ)
        - alert: NodeDiskSpaceWarning
          expr: |
            (1 - (node_filesystem_avail_bytes{fstype!="tmpfs",mountpoint="/"} / node_filesystem_size_bytes)) * 100 > 80
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ ë…¸ë“œ ë””ìŠ¤í¬ ë¶€ì¡±: {{ $labels.instance }}"
            description: "ë””ìŠ¤í¬ ì‚¬ìš©ë¥  {{ $value | humanize }}%. ë¡œê·¸ ì •ë¦¬ í•„ìš”."

        # 14. ë””ìŠ¤í¬ ìš©ëŸ‰ Critical (90% ì´ìƒ)
        - alert: NodeDiskSpaceCritical
          expr: |
            (1 - (node_filesystem_avail_bytes{fstype!="tmpfs",mountpoint="/"} / node_filesystem_size_bytes)) * 100 > 90
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "ğŸš¨ ë…¸ë“œ ë””ìŠ¤í¬ ê±°ì˜ ê°€ë“ ì°¸: {{ $labels.instance }}"
            description: "ë””ìŠ¤í¬ ì‚¬ìš©ë¥  {{ $value | humanize }}%. ì¦‰ì‹œ ìš©ëŸ‰ í™•ë³´ í•„ìš”!"

    # ==============================================
    # Phase 4: ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì•ŒëŒ (ì €íŠ¸ë˜í”½ ìµœì í™”)
    # ==============================================
    - name: starlight_app_performance
      interval: 1m
      rules:
        # 15. HTTP 5xx ì—ëŸ¬ ë°œìƒ (ì €íŠ¸ë˜í”½ì´ë¼ ì ˆëŒ€ê°’ìœ¼ë¡œ)
        - alert: StarlightHTTP5xxErrors
          expr: |
            sum(rate(nginx_ingress_controller_requests{namespace="starlight-production", status=~"5.."}[5m])) > 0.1
          for: 5m
          labels:
            severity: warning
            service: starlight
          annotations:
            summary: "âš ï¸ Starlight 5xx ì—ëŸ¬ ë°œìƒ"
            description: "5ë¶„ê°„ í‰ê·  {{ $value | humanize }} req/sì˜ 5xx ì—ëŸ¬ ë°œìƒ ì¤‘"

        # 16. HTTP 5xx ì—ëŸ¬ìœ¨ (íŠ¸ë˜í”½ ë§ì•„ì§€ë©´ í™œì„±í™”)
        - alert: StarlightHighErrorRate
          expr: |
            (
              sum(rate(nginx_ingress_controller_requests{namespace="starlight-production", status=~"5.."}[5m]))
              / 
              sum(rate(nginx_ingress_controller_requests{namespace="starlight-production"}[5m]))
            ) * 100 > 5
          for: 5m
          labels:
            severity: critical
            service: starlight
          annotations:
            summary: "ğŸš¨ Starlight ì—ëŸ¬ìœ¨ {{ $value | humanize }}%"
            description: "5ë¶„ê°„ ì—ëŸ¬ìœ¨ì´ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì‹¬ê°í•œ ì¥ì•  ê°€ëŠ¥ì„±!"

        # 17. API ì‘ë‹µ ëŠë¦¼ (P95 ê¸°ì¤€)
        - alert: StarlightSlowResponse
          expr: |
            histogram_quantile(0.95, 
              sum(rate(nginx_ingress_controller_request_duration_seconds_bucket{namespace="starlight-production"}[5m])) by (le)
            ) > 2
          for: 10m
          labels:
            severity: warning
            service: starlight
          annotations:
            summary: "âš ï¸ Starlight API ì‘ë‹µ ëŠë¦¼ (P95: {{ $value }}ì´ˆ)"
            description: "95%tile ì‘ë‹µì‹œê°„ì´ 2ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì„±ëŠ¥ ìµœì í™” í•„ìš”."

        # 18. íŠ¸ë˜í”½ ê¸‰ê° (ì¥ì•  ì§•í›„)
        - alert: StarlightTrafficDrop
          expr: |
            sum(rate(nginx_ingress_controller_requests{namespace="starlight-production"}[5m])) 
            < sum(rate(nginx_ingress_controller_requests{namespace="starlight-production"}[5m] offset 1h)) * 0.3
          for: 10m
          labels:
            severity: warning
            service: starlight
          annotations:
            summary: "âš ï¸ Starlight íŠ¸ë˜í”½ ê¸‰ê°"
            description: "í‰ì†Œ ëŒ€ë¹„ 70% ì´ìƒ íŠ¸ë˜í”½ ê°ì†Œ. ì„œë¹„ìŠ¤ ì ‘ê·¼ ë¶ˆê°€ ê°€ëŠ¥ì„±."

    # ==============================================
    # Phase 5: ArgoCD & GitOps ì•ŒëŒ
    # ==============================================
    - name: argocd_deployment_alerts
      interval: 2m
      rules:
        # 19. ArgoCD App OutOfSync
        - alert: ArgoCDOutOfSync
          expr: |
            argocd_app_info{sync_status!="Synced"} > 0
          for: 15m
          labels:
            severity: warning
            component: argocd
          annotations:
            summary: "âš ï¸ ArgoCD ë™ê¸°í™” ì‹¤íŒ¨: {{ $labels.name }}"
            description: "{{ $labels.name }} ì•±ì´ 15ë¶„ ì´ìƒ OutOfSync ìƒíƒœì…ë‹ˆë‹¤."

        # 20. ArgoCD App Health Degraded
        - alert: ArgoCDAppDegraded
          expr: |
            argocd_app_info{health_status!~"Healthy|Progressing"} > 0
          for: 10m
          labels:
            severity: critical
            component: argocd
          annotations:
            summary: "ğŸš¨ ArgoCD ì•± ìƒíƒœ ë¶ˆëŸ‰: {{ $labels.name }}"
            description: "{{ $labels.name }} í—¬ìŠ¤ ìƒíƒœ: {{ $labels.health_status }}"

    # ==============================================
    # Phase 6: ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ìì²´ í—¬ìŠ¤ì²´í¬
    # ==============================================
    - name: monitoring_stack_health
      interval: 1m
      rules:
        # 21. Prometheus íƒ€ê²Ÿ ë‹¤ìš´
        - alert: PrometheusTargetDown
          expr: |
            up{namespace="monitoring"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "âš ï¸ Prometheus íƒ€ê²Ÿ ë‹¤ìš´: {{ $labels.job }}"
            description: "{{ $labels.instance }} ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹¤íŒ¨"

        # 22. AlertManager ë‹¤ìš´
        - alert: AlertManagerDown
          expr: |
            up{job="prometheus-kube-prometheus-alertmanager"} == 0
          for: 3m
          labels:
            severity: critical
          annotations:
            summary: "ğŸš¨ AlertManager ë‹¤ìš´"
            description: "ì•ŒëŒ ì „ì†¡ ë¶ˆê°€ ìƒíƒœ! ì¦‰ì‹œ ë³µêµ¬ í•„ìš”."